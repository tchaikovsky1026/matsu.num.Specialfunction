/*
 * Copyright © 2024 Matsuura Y.
 * 
 * This software is released under the MIT License.
 * http://opensource.org/licenses/mit-license.php
 */
/*
 * 2024.12.31
 */
package matsu.num.specialfunction.gamma;

import java.util.Objects;

import matsu.num.specialfunction.common.Exponentiation;

/**
 * ガンマ関数の計算.
 * 
 * @author Matsuura Y.
 * @version 22.0
 */
public final class GammaCalculation {

    private static final int GAMMA_MAX = 171;
    private static final double GAMMA_THRESHOLD = 3;

    private final LGammaCalculation lGamma;
    private final double[] intGammaTable;

    /**
     * 唯一のコンストラクタ.
     * 
     * @param lGamma lgamma
     */
    public GammaCalculation(LGammaCalculation lGamma) {
        super();

        this.lGamma = Objects.requireNonNull(lGamma);
        intGammaTable = new double[] {
                1d, 1d, 2d, 6d, 24d,
                120d, 720d, 5040d, 40320d, 362880d,
                3628800d, 39916800d, 479001600d, 6227020800d, 87178291200d,
                1307674368000d, 20922789888000d, 355687428096000d, 6402373705728000d, 121645100408832000d,
                2432902008176640000d, 51090942171709440000d, 1124000727777607680000d, 2.585201673888497664E+22d,
                6.2044840173323943936E+23d,
                1.5511210043330985984E+25d, 4.03291461126605635584E+26d, 1.088886945041835216077E+28d,
                3.048883446117138605015E+29d, 8.841761993739701954544E+30d,
                2.652528598121910586363E+32d, 8.222838654177922817726E+33d, 2.631308369336935301672E+35d,
                8.683317618811886495518E+36d, 2.952327990396041408476E+38d,
                1.033314796638614492967E+40d, 3.71993326789901217468E+41d, 1.376375309122634504632E+43d,
                5.2302261746660111176E+44d, 2.039788208119744335864E+46d,
                8.159152832478977343456E+47d, 3.345252661316380710817E+49d, 1.405006117752879898543E+51d,
                6.041526306337383563736E+52d, 2.658271574788448768044E+54d,
                1.19622220865480194562E+56d, 5.50262215981208894985E+57d, 2.58623241511168180643E+59d,
                1.241391559253607267086E+61d, 6.082818640342675608723E+62d,
                3.041409320171337804361E+64d, 1.551118753287382280224E+66d, 8.065817517094387857166E+67d,
                4.274883284060025564298E+69d, 2.308436973392413804721E+71d,
                1.269640335365827592597E+73d, 7.10998587804863451854E+74d, 4.052691950487721675568E+76d,
                2.350561331282878571829E+78d, 1.386831185456898357379E+80d,
                8.320987112741390144276E+81d, 5.075802138772247988009E+83d, 3.146997326038793752565E+85d,
                1.982608315404440064116E+87d, 1.268869321858841641034E+89d,
                8.247650592082470666723E+90d, 5.443449390774430640037E+92d, 3.647111091818868528825E+94d,
                2.480035542436830599601E+96d, 1.711224524281413113725E+98d,
                1.197857166996989179607E+100d, 8.504785885678623175212E+101d, 6.123445837688608686152E+103d,
                4.470115461512684340891E+105d, 3.30788544151938641226E+107d,
                2.480914081139539809195E+109d, 1.885494701666050254988E+111d, 1.451830920282858696341E+113d,
                1.132428117820629783146E+115d, 8.946182130782975286851E+116d,
                7.156945704626380229481E+118d, 5.79712602074736798588E+120d, 4.753643337012841748421E+122d,
                3.94552396972065865119E+124d, 3.314240134565353266999E+126d,
                2.817104114380550276949E+128d, 2.422709538367273238177E+130d, 2.107757298379527717214E+132d,
                1.854826422573984391148E+134d, 1.650795516090846108122E+136d,
                1.48571596448176149731E+138d, 1.352001527678402962552E+140d, 1.243841405464130725548E+142d,
                1.156772507081641574759E+144d, 1.087366156656743080274E+146d,
                1.03299784882390592626E+148d, 9.916779348709496892096E+149d, 9.619275968248211985333E+151d,
                9.426890448883247745626E+153d, 9.33262154439441526817E+155d,
                9.33262154439441526817E+157d, 9.425947759838359420852E+159d, 9.614466715035126609269E+161d,
                9.902900716486180407547E+163d, 1.029901674514562762385E+166d,
                1.081396758240290900504E+168d, 1.146280563734708354534E+170d, 1.226520203196137939352E+172d,
                1.3246418194518289745E+174d, 1.443859583202493582205E+176d,
                1.588245541522742940425E+178d, 1.762952551090244663872E+180d, 1.974506857221074023537E+182d,
                2.231192748659813646597E+184d, 2.54355973347218755712E+186d,
                2.925093693493015690688E+188d, 3.393108684451898201198E+190d, 3.969937160808720895402E+192d,
                4.684525849754290656574E+194d, 5.574585761207605881323E+196d,
                6.689502913449127057588E+198d, 8.094298525273443739682E+200d, 9.875044200833601362412E+202d,
                1.214630436702532967577E+205d, 1.506141741511140879795E+207d,
                1.882677176888926099744E+209d, 2.372173242880046885677E+211d, 3.01266001845765954481E+213d,
                3.856204823625804217357E+215d, 4.97450422247728744039E+217d,
                6.466855489220473672507E+219d, 8.471580690878820510985E+221d, 1.11824865119600430745E+224d,
                1.487270706090685728909E+226d, 1.992942746161518876737E+228d,
                2.690472707318050483595E+230d, 3.65904288195254865769E+232d, 5.012888748274991661035E+234d,
                6.917786472619488492228E+236d, 9.615723196941089004197E+238d,
                1.346201247571752460588E+241d, 1.898143759076170969429E+243d, 2.695364137888162776589E+245d,
                3.854370717180072770522E+247d, 5.550293832739304789551E+249d,
                8.047926057471991944849E+251d, 1.174997204390910823948E+254d, 1.727245890454638911204E+256d,
                2.556323917872865588581E+258d, 3.808922637630569726986E+260d,
                5.713383956445854590479E+262d, 8.627209774233240431623E+264d, 1.311335885683452545607E+267d,
                2.006343905095682394778E+269d, 3.089769613847350887959E+271d,
                4.789142901463393876336E+273d, 7.471062926282894447084E+275d, 1.172956879426414428192E+278d,
                1.853271869493734796544E+280d, 2.946702272495038326504E+282d,
                4.714723635992061322407E+284d, 7.590705053947218729075E+286d, 1.22969421873944943411E+289d,
                2.0044015765453025776E+291d, 3.287218585534296227263E+293d,
                5.423910666131588774984E+295d, 9.003691705778437366474E+297d, 1.503616514864999040201E+300d,
                2.526075744973198387538E+302d, 4.269068009004705274939E+304d,
                7.257415615307998967397E+306d
        };
    }

    /**
     * ガンマ関数 &Gamma;(<i>x</i>) を計算する.
     *
     * @param x x, 引数
     * @return &Gamma;(x)
     */
    public double gamma(double x) {
        /*
         * x < 0: NaN
         * x = 0: +inf
         * x = +inf: +inf
         */
        if (!(x >= 0)) {
            return Double.NaN;
        }
        if (x > GAMMA_THRESHOLD) {
            return Exponentiation.exp(lGamma.lgamma(x));
        }

        assert x <= 3d;

        switch ((int) (2 * x)) {
            case 0: {
                // x + 0dは, x=-0d への配慮
                return gamma1p_m0_5_to_0_5(x) / (x + 0d);
            }
            case 1, 2: {
                return gamma1p_m0_5_to_0_5(x - 1d);
            }
            case 3, 4: {
                return (x - 1d) * gamma1p_m0_5_to_0_5(x - 2d);
            }
            default:
                return (x - 1d) * (x - 2d) * gamma1p_m0_5_to_0_5(x - 3d);
        }
    }

    /**
     * {@literal -0.5 <= x <= 0.5} におけるGamma(1+x)
     */
    private double gamma1p_m0_5_to_0_5(double x) {
        assert x >= -0.5;
        assert x <= 0.5;

        //1/Γ(1+x)を計算し, 逆数をとって返す.
        final double C0 = 0.99999999999999999566056458775722; // C0 = 1dである.
        final double C1 = 0.57721566490153311614240826552387;
        final double C2 = -0.65587807152025187505690756737124;
        final double C3 = -0.042002635034134241430230332161088;
        final double C4 = 0.16653861138213774590438474709323;
        final double C5 = -0.042197734553824257308705712654779;
        final double C6 = -0.0096219715233496651386085682551894;
        final double C7 = 0.0072189432132061281061955511043432;
        final double C8 = -0.0011651676577866355989257938630416;
        final double C9 = -0.00021524133914593566377912266815152;
        final double C10 = 0.00012805080669061585962913680615077;
        final double C11 = -0.000020136663744698520934194609425779;
        final double C12 = -0.0000012528133910170696217885055905421;
        final double C13 = 0.0000011380985582075846428368493949507;
        final double C14 = -2.0027639428205237599984033411035E-7;

        final double x2 = x * x;

        final double v0 = C0 + x * C1 + x2 * (C2 + x * C3);
        final double v4 = C4 + x * C5 + x2 * (C6 + x * C7);
        final double v8 = C8 + x * C9 + x2 * (C10 + x * C11);
        final double v12 = C12 + x * C13 + x2 * (C14);

        final double x4 = x2 * x2;

        double inv = v0 + x4 * (v4 + x4 * (v8 + x4 * v12));

        return 1 / inv;
    }

    /**
     * 整数引数のガンマ関数 &Gamma;(<i>n</i>) を計算する.
     * 
     * @param n
     * @return gamma(n)
     */
    public double gamma(int n) {
        /*
         * n < 0: NaN.
         * n = 0 or n >> 1: +inf
         */
        if (n >= 1 && n <= GAMMA_MAX) {
            return intGammaTable[n - 1];
        } else if (n >= 0) {
            return Double.POSITIVE_INFINITY;
        } else {
            return Double.NaN;
        }
    }
}
